<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chattr XP â€¢ Neon (Parent + Profiles)</title>
<style>
  :root {
    --bg:#111216; --surface:#1c1f25; --text:#f8fafc;
    --primary:#0ea5e9; --secondary:#ec4899; --success:#10b981; --danger:#ef4444; --muted:#9aa5b1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{width:min(820px,94vw);background:var(--surface);border-radius:20px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1,h2,h3{margin:8px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .between{justify-content:space-between}
  .center{text-align:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .16s}
  .btn:hover{transform:translateY(-1px)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .linklike{background:transparent;border:0;color:var(--muted);text-decoration:underline;cursor:pointer}
  .avatars span{font-size:32px;padding:6px 10px;border-radius:10px;cursor:pointer}
  .avatars span.sel{outline:2px solid var(--secondary)}
  .emoji{font-size:38px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .answer{padding:14px;background:#222733;border-radius:14px;cursor:pointer;user-select:none;transition:transform .12s,background .12s}
  .answer:hover{transform:scale(1.02);background:#263042}
  .correct{background:var(--success)!important}
  .wrong{background:var(--danger)!important}
  .bar{height:12px;width:100%;background:#2a2e36;border-radius:8px;overflow:hidden;margin:8px 0 4px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .28s}
  .meta{color:var(--muted);font-size:14px}
  .hide{display:none!important}
  .gear{position:absolute;top:14px;right:14px;font-size:22px;cursor:pointer;opacity:.85}
  .gear:hover{opacity:1;transform:rotate(15deg)}
  .topbar{position:relative}
  .badge{font-size:12px;color:#aab3bd}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#273042;color:#cfe8f8;font-size:12px}

  /* Modal + admin styles */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(720px,92vw);background:#171a20;border:1px solid #2b3240;border-radius:16px;padding:18px}
  .hr{height:1px;background:#2a3240;margin:10px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 12px;border-radius:999px;background:#243041;color:#d9e7f4;cursor:pointer;border:1px solid #314058}
  .chip.sel{outline:2px solid var(--primary)}
  .section{padding:10px;border:1px solid #2c3546;border-radius:12px;margin:8px 0}
  label{display:block;margin:6px 0}
  input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:10px;border:1px solid #364055;background:#0f1217;color:#eaf2ff}

  /* Confetti */
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;font-size:22px;animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(100vh) rotate(360deg);opacity:0}}

  /* hide Progress section */
  #progress-section { display:none; }
</style>
</head>
<body>

<div class="wrap">
  <div class="card" id="screen-home">
    <div class="topbar">
      <div class="gear" id="btn-gear" title="Parent">âš™ï¸</div>
    </div>
    <div class="center">
      <div class="emoji">âœ¨</div>
      <h1>Chattr XP</h1>
      <p class="meta" id="home-sub">Level up your social game. Have fun while youâ€™re at it.</p>
      <div class="row center" style="justify-content:center;margin-top:10px">
        <div class="avatars" id="avatars">
          <span>ğŸ˜âœ¨</span><span>ğŸ§âš¡</span><span>ğŸ€ğŸ’¥</span><span>ğŸ®â­</span><span>ğŸ“šğŸ’¡</span><span>ğŸ§ ğŸ”“</span>
        </div>
      </div>
      <div class="row center" style="justify-content:center;margin-top:14px;gap:8px">
        <button class="btn" id="btn-play">Play</button>
        <button class="btn ghost" id="btn-profile">Profile</button>
      </div>
      <p class="badge" id="active-profile-badge"></p>
    </div>
  </div>

  <div class="card hide" id="screen-quiz">
    <div class="row between">
      <div><span id="avatar" class="emoji">ğŸ˜âœ¨</span> <span class="pill" id="pill-areas"></span></div>
      <div class="meta">ğŸ”¥ Streak: <b id="streak">0</b></div>
    </div>
    <div class="bar"><div id="xpfill"></div></div>
    <div class="meta"><span id="xptext">XP 0</span> Â· Level <span id="level">1</span></div>
    <h3 id="qtext" style="margin-top:10px"></h3>
    <div class="grid2" id="answers"></div>
    <div id="feedback" class="meta" style="margin-top:6px"></div>
    <div class="row between" style="margin-top:12px">
      <button class="btn ghost" id="btn-exit">Exit</button>
      <button class="btn" id="btn-next" disabled>Next</button>
    </div>
  </div>

  <div class="card hide" id="screen-profile">
    <div class="center">
      <h2>Profile</h2>
      <div class="emoji" id="pAvatar">ğŸ˜âœ¨</div>
      <p class="meta">Theme: Neon Â· Sounds: Off</p>
      <div class="row center" style="justify-content:center;gap:8px;margin-top:8px">
        <button class="btn" id="btn-play-again">Play Again</button>
        <button class="btn ghost" id="btn-reset">Reset Progress</button>
      </div>
    </div>
  </div>
</div>

<!-- Parent Modal -->
<div class="modal-backdrop hide" id="parent-modal">
  <div class="modal">
    <div class="row between">
      <h3 style="margin:0">Parent</h3>
      <button class="linklike" id="close-parent">Close</button>
    </div>

    <div id="parent-locked" class="section">
      <div class="kicker">Enter Parent PIN</div>
      <input type="password" id="pin-input" placeholder="4â€“8 digits" />
      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn" id="btn-pin-enter">Enter</button>
        <button class="btn ghost" id="btn-pin-help">Forgot?</button>
      </div>
      <p class="meta" id="pin-msg"></p>
    </div>

    <div id="parent-dash" class="hide">
      <div class="section">
        <div class="kicker">Child Profiles</div>
        <div class="chips" id="profile-chips"></div>
        <div class="row" style="margin-top:8px;gap:8px">
          <input type="text" id="new-profile-name" placeholder="Add a profile (e.g., Zeva)" />
          <button class="btn" id="btn-add-profile">Add</button>
          <button class="btn ghost" id="btn-del-profile">Delete Active</button>
        </div>
        <p class="meta">Use URL like <code>?profile=Zeva</code> to open directly.</p>
      </div>

      <div class="section">
        <div class="kicker">Age Category (for active profile)</div>
        <div class="chips" id="age-chips"></div>
        <p class="meta">Parents pick the track: 8â€“10, 11â€“13, or 14+. Content adjusts automatically.</p>
      </div>

      <div class="section">
        <div class="kicker">Focus Areas (shown to parents only)</div>
        <div class="chips" id="area-chips"></div>
        <div class="row" style="margin-top:8px;gap:8px">
          <button class="btn" id="btn-all-areas">All Areas</button>
          <button class="btn ghost" id="btn-save-areas">Save</button>
        </div>
        <p class="meta">Kids wonâ€™t see area names; they just tap Play.</p>
      </div>

      <div class="section" id="progress-section">
        <div class="kicker">Progress</div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btn-reset-active">Reset Active Profile</button>
          <button class="btn ghost" id="btn-export">Export Progress (JSON)</button>
          <button class="btn ghost" id="btn-import">Import Progress</button>
          <input type="file" id="import-file" class="hide" accept="application/json"/>
        </div>
      </div>

      <div class="section">
        <div class="kicker">Parent PINs</div>
        <p class="meta">You can store more than one PIN (e.g., two parents).</p>
        <div class="row" style="gap:8px">
          <input type="password" id="pin-new" placeholder="Add new PIN" />
          <button class="btn" id="btn-add-pin">Add PIN</button>
          <button class="btn ghost" id="btn-list-pins">List Count</button>
          <button class="btn ghost" id="btn-clear-pins">Clear All PINs</button>
        </div>
        <p class="meta" id="pin-admin-msg"></p>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Supabase Connection -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL  = 'https://ogogdoumibnaregigoap.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nb2dkb3VtaWJuYXJlZ2lnb2FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNTM2MTcsImV4cCI6MjA3NTcyOTYxN30.s1Ggyfqb-K2dN9VIX9c7vM0T_KSoC7Gems92TxEIk48';
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
  window.__sb = sb;

  async function fetchBatch(areaIds, age, limit = 300) {
    const { data, error } = await sb
      .from('questions')
      .select('id, area_id, prompt, choices, explanations, correct_index, age_group')
      .in('area_id', areaIds)
      .eq('age_group', age)
      .eq('is_active', true)
      .limit(limit);

    if (error) {
      console.error('Error loading questions:', error);
      return [];
    }
    return data.map(row => ({
      __id: row.id,
      area: row.area_id,
      q: row.prompt,
      a: row.choices,
      e: row.explanations,
      c: row.correct_index
    }));
  }
  window.fetchBatch = fetchBatch;
</script>

<!-- ğŸ® Main Game + Dashboard -->
<script>
const DEV_MODE = location.search.includes('dev=1');
const RESET_NOW = location.search.includes('reset=1');
const url = new URL(location.href);
const PARAM_PROFILE = (url.searchParams.get('profile') || '').trim();

const AREAS = [
  { id:'chill',  name:'Calm & Reset' },
  { id:'reading',name:'Read the Room' },
  { id:'follow', name:'Show Up & Follow Through' },
  { id:'friend', name:'Friendship Moves' },
];
const AGE_GROUPS = ['8-10','11-13','14+'];

const LS_KEY = "cxp_state_v2";
function defaultState(){
  return {
    settings:{ parentPins:[], enabledAreas: AREAS.map(a=>a.id) },
    profiles:{ "Player": baseProfile() },
    activeProfile:"Player"
  };
}
function baseProfile(){ return { avatar:'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{}, answeredToday:0, age:'11-13' }; }
let S = loadState();
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(S)); }catch{} }
function loadState(){
  try{
    const v = JSON.parse(localStorage.getItem(LS_KEY)||"null") || defaultState();
    v.settings ||= { parentPins:[], enabledAreas: AREAS.map(a=>a.id) };
    v.profiles ||= {"Player": baseProfile()};
    v.activeProfile ||= "Player";
    return v;
  }catch{ return defaultState(); }
}

function $(s){return document.querySelector(s)}
function $all(s){return [...document.querySelectorAll(s)]}
function show(id){['#screen-home','#screen-quiz','#screen-profile'].forEach(sel=>$(sel).classList.add('hide'));$(id).classList.remove('hide');}
function shuffleInPlace(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
function confetti(){const c=document.body.appendChild(Object.assign(document.createElement('div'),{id:'confetti',className:'confetti'}));for(let i=0;i<20;i++){const s=document.createElement('span');s.className='piece';s.textContent=['âœ¨','ğŸ’«','ğŸŒŸ','ğŸ‰','â­'][Math.floor(Math.random()*5)];s.style.left=(Math.random()*100)+'%';s.style.animationDelay=(Math.random()*0.25)+'s';c.appendChild(s);setTimeout(()=>s.remove(),1400);}}

/* Profiles */
function getProfileName(){ return PARAM_PROFILE || S.activeProfile || "Player"; }
function ensureProfile(name){ if(!S.profiles[name]) S.profiles[name]=baseProfile(); }
function activeP(){ const n=getProfileName(); ensureProfile(n); S.activeProfile=n; return S.profiles[n]; }
function renderHomeBadge(){ $('#active-profile-badge').textContent = `Active profile: ${getProfileName()}`; }

/* Question pool */
let POOL = [];
async function buildPool(){
  const enabled = new Set(S.settings.enabledAreas);
  const areas = [...enabled];
  const age = activeP().age || '11-13';
  const batch = await window.fetchBatch(areas, age, 300);
  POOL = batch.map((q, idx) => ({ q, idx }));
  shuffleInPlace(POOL);
}

/* Quiz engine */
let servedCount = 0;
let awaitingManualAdvance = false;
let currentQ = null;
const POINTS_PER_CORRECT = 10;

$('#btn-exit').onclick=()=>show('#screen-home');
$('#btn-next').onclick=()=>next(true);
$('#btn-play').onclick=()=>startSession();
$('#btn-profile').onclick=()=>{ $('#pAvatar').textContent=activeP().avatar; show('#screen-profile'); };
$('#btn-play-again').onclick=()=>startSession();
$('#btn-reset').onclick=()=>{ const n=getProfileName(); S.profiles[n]={...baseProfile(),avatar:S.profiles[n]?.avatar||'ğŸ˜âœ¨'}; saveState(); alert('Progress reset.'); };

async function startSession(){
  await buildPool();
  servedCount=0; awaitingManualAdvance=false;
  $('#avatar').textContent=activeP().avatar;
  renderAreaPill(); renderBars();
  show('#screen-quiz'); next(true);
}
function next(manual=false){
  if (awaitingManualAdvance && !manual) return;
  $('#btn-next').disabled=true; $('#feedback').textContent='';
  const i=servedCount; if(!POOL[i]){ show('#screen-home'); return; }
  servedCount++; loadQuestion(i);
}
function loadQuestion(i){
  const base=POOL[i].q;
  const map=[0,1,2,3]; shuffleInPlace(map);
  const shuffledA=map.map(k=>base.a[k]);
  const shuffledE=map.map(k=>base.e[k]);
  const correctIdx=map.indexOf(base.c);
  currentQ={__idx:i,area:base.area,q:base.q,a:shuffledA,e:shuffledE,correctIdx};
  $('#qtext').textContent=currentQ.q;
  const box=$('#answers'); box.innerHTML='';
  currentQ.a.forEach((t,ix)=>{ const d=document.createElement('div'); d.className='answer'; d.textContent=t; d.onclick=()=>choose(ix,d); box.appendChild(d); });
  window.scrollTo({top:0,behavior:'smooth'});
}
function choose(choiceIdx,el){
  $all('.answer').forEach(a=>a.onclick=null);
  const correct=(choiceIdx===currentQ.correctIdx);
  const p=activeP();
  if(correct){
    el.classList.add('correct'); markCompleted(currentQ.__idx);
    p.streak=(p.streak||0)+1; awardPoints(p);
    $('#feedback').textContent=`âœ… Nice. ${currentQ.e[choiceIdx]}`; confetti();
  } else {
    el.classList.add('wrong'); p.streak=0;
    $('#feedback').textContent=`Thanks for thinking it through. ${currentQ.e[choiceIdx]}`;
  }
  saveState(); renderBars(); awaitingManualAdvance=true; $('#btn-next').disabled=false;
}
function renderBars(){ const p=activeP(); $('#streak').textContent=p.streak||0; $('#xptext').textContent=`XP ${p.xp||0}`; $('#level').textContent=p.level||1; $('#xpfill').style.width=Math.min(100,(p.xp%100))+'%'; }
function awardPoints(p){ p.xp=(p.xp||0)+POINTS_PER_CORRECT; p.level=1+Math.floor((p.xp||0)/100); }
function markCompleted(idx){ activeP().completed[idx]=true; }
function renderAreaPill(){ 
  const enabled=new Set(S.settings.enabledAreas); 
  const names=AREAS.filter(a=>enabled.has(a.id)).map(a=>a.name); 
  const label = names.length===AREAS.length?'All Modes':names.join(' â€¢ ');
  const age = activeP().age || '11-13';
  $('#pill-areas').textContent = `${label} â€¢ ${age}`;
}

/* Avatar picker */
$all('#avatars span').forEach(sp=>{
  if (sp.textContent===activeP().avatar) sp.classList.add('sel');
  sp.onclick=()=>{ $all('#avatars span').forEach(x=>x.classList.remove('sel')); sp.classList.add('sel'); activeP().avatar=sp.textContent; saveState(); renderHomeBadge(); };
});

/* Parent modal */
const elParentModal = $('#parent-modal');
$('#btn-gear').onclick = ()=>{ openParentModal(); };
$('#close-parent').onclick = ()=>{ elParentModal.classList.add('hide'); };
elParentModal.addEventListener('click',(e)=>{ if(e.target===elParentModal){ elParentModal.classList.add('hide'); }});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !elParentModal.classList.contains('hide')) elParentModal.classList.add('hide'); });

function openParentModal(){
  $('#pin-input').value=''; $('#pin-msg').textContent='';
  $('#parent-locked').classList.remove('hide');
  $('#parent-dash').classList.add('hide');
  elParentModal.classList.remove('hide');
}
$('#btn-pin-enter').onclick = ()=>{
  const pin = ($('#pin-input').value||'').trim();
  if (!pin) return;
  if (S.settings.parentPins.length===0){
    S.settings.parentPins=[pin]; saveState();
    $('#pin-msg').textContent="PIN created."; showDash();
  } else {
    if (S.settings.parentPins.includes(pin)){ $('#pin-msg').textContent="Unlocked."; showDash(); }
    else { $('#pin-msg').textContent="That PIN doesnâ€™t match."; }
  }
};
$('#btn-pin-help').onclick = ()=>{
  $('#pin-msg').textContent = S.settings.parentPins.length
    ? "Tip: you can replace PINs by adding a new one in the dashboard."
    : "No PIN set yet. Enter one now to create it.";
};
function showDash(){
  $('#parent-locked').classList.add('hide');
  $('#parent-dash').classList.remove('hide');
  renderProfilesAdmin(); renderAreaChips(); renderAgeChips();
  $('#pin-admin-msg').textContent='';
}

/* Profiles admin */
function renderProfilesAdmin(){
  const cont = $('#profile-chips'); cont.innerHTML='';
  Object.keys(S.profiles).forEach(name=>{
    const d=document.createElement('div');
    d.className='chip'+(name===getProfileName()?' sel':'' );
    d.textContent=name;
    d.onclick=()=>{ S.activeProfile=name; saveState(); renderProfilesAdmin(); renderHomeBadge(); renderAgeChips(); };
    cont.appendChild(d);
  });
}
$('#btn-add-profile').onclick=()=>{
  const name = ($('#new-profile-name').value||'').trim();
  if (!name) return;
  if (!S.profiles[name]) S.profiles[name]=baseProfile();
  S.activeProfile=name; saveState(); $('#new-profile-name').value='';
  renderProfilesAdmin(); renderHomeBadge(); renderAgeChips();
};
$('#btn-del-profile').onclick=()=>{
  const name=getProfileName();
  if (name==='Player'){ alert('Cannot delete the default profile.'); return; }
  delete S.profiles[name]; S.activeProfile='Player'; saveState(); renderProfilesAdmin(); renderHomeBadge();
};

/* Age chips */
function renderAgeChips(){
  const cont = $('#age-chips'); 
  if (!cont) return;
  cont.innerHTML = '';
  const prof = activeP();
  AGE_GROUPS.forEach(age=>{
    const d = document.createElement('div');
    d.className = 'chip' + (prof.age === age ? ' sel' : '');
    d.textContent = age;
    d.onclick = () => {
      prof.age = age;
      saveState();
      renderAgeChips();
      renderAreaPill();
    };
    cont.appendChild(d);
  });
}

/* Areas admin */
function renderAreaChips(){
  const cont=$('#area-chips'); cont.innerHTML='';
  AREAS.forEach(a=>{
    const d=document.createElement('div');
    d.className='chip'+(S.settings.enabledAreas.includes(a.id)?' sel':'' );
    d.textContent=a.name;
    d.onclick=()=>{
      const set=new Set(S.settings.enabledAreas);
      if(set.has(a.id)) set.delete(a.id); else set.add(a.id);
      S.settings.enabledAreas=[...set]; saveState(); renderAreaChips(); renderAreaPill();
    };
    cont.appendChild(d);
  });
}
$('#btn-all-areas').onclick=()=>{ S.settings.enabledAreas=AREAS.map(a=>a.id); saveState(); renderAreaChips(); renderAreaPill(); };
$('#btn-save-areas').onclick=()=>{ saveState(); alert('Saved. Kids will only see Play.'); };

/* Progress admin */
$('#btn-reset-active').onclick=()=>{ const n=getProfileName(); S.profiles[n]={...baseProfile(),avatar:(S.profiles[n]?.avatar||'ğŸ˜âœ¨')}; saveState(); alert(`Reset progress for ${n}.`); };
$('#btn-export').onclick=()=>{ const blob = new Blob([JSON.stringify(S,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='chattrxp_progress.json'; a.click(); URL.revokeObjectURL(a.href); };
$('#btn-import').onclick=()=>$('#import-file').click();
$('#import-file').onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); S=obj; saveState(); renderProfilesAdmin(); renderAreaChips(); renderHomeBadge(); alert('Imported.'); }catch{ alert('Invalid file.'); } }; r.readAsText(f); };

/* PIN admin */
$('#btn-add-pin').onclick=()=>{ const p=($('#pin-new').value||'').trim(); if(!p) return; const set=new Set(S.settings.parentPins); set.add(p); S.settings.parentPins=[...set]; $('#pin-new').value=''; saveState(); $('#pin-admin-msg').textContent=`Stored PINs: ${S.settings.parentPins.length}`; };
$('#btn-list-pins').onclick=()=>{ $('#pin-admin-msg').textContent=`Stored PINs: ${S.settings.parentPins.length}`; };
$('#btn-clear-pins').onclick=()=>{ if (confirm('Remove all stored PINs?')){ S.settings.parentPins=[]; saveState(); $('#pin-admin-msg').textContent='All PINs cleared.'; } };

/* Boot */
(function boot(){
  ensureProfile(getProfileName());
  if (RESET_NOW){ const n=getProfileName(); S.profiles[n] = { ...baseProfile(), avatar:(S.profiles[n]?.avatar||'ğŸ˜âœ¨') }; saveState(); }
  $('#pAvatar').textContent=activeP().avatar;
  $('#avatar').textContent=activeP().avatar;
  renderHomeBadge(); renderAreaPill(); renderBars();
  show('#screen-home');
})();
</script>

<div id="confetti" class="confetti"></div>
</body>
</html>

