<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chattr XP ‚Ä¢ Neon Preview (v12)</title>
<style>
  :root { --bg:#111216; --surface:#1E1F24; --text:#F8FAFC; --primary:#0EA5E9; --secondary:#EC4899; --success:#10B981; --danger:#ef4444; --muted:#94a3b8; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center}
  .card{width:min(820px,92vw);background:var(--surface);border-radius:20px;padding:22px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1,h2,h3{margin:8px 0}.center{text-align:center}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .16s}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn:hover{transform:translateY(-1px)}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .answer{padding:14px;background:#20232a;border-radius:14px;cursor:pointer;user-select:none;transition:transform .12s,background .12s}
  .answer:hover{transform:scale(1.02);background:#262a33}
  .correct{background:var(--success)!important}
  .wrong{background:var(--danger)!important}
  .bar{height:12px;width:100%;background:#2a2e36;border-radius:8px;overflow:hidden;margin:8px 0 4px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .28s}
  .meta{color:var(--muted);font-size:14px}
  .emoji{font-size:38px}
  .hide{display:none!important}
  .spacer{height:8px}
  .badge{font-size:12px;color:#aaa}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a2e36;padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd5e1}
  .pill b{color:#fff}
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;font-size:22px;animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(100vh) rotate(360deg);opacity:0}}

  /* Parent modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center}
  .modal{width:min(720px,92vw);background:#17181d;border:1px solid #2a2e36;border-radius:16px;padding:16px}
  .formrow{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:8px 0}
  .input, .pin{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #30333b;background:#1f2127;color:#fff}
  .checkgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}
  .check{display:flex;gap:8px;align-items:center;padding:10px;border:1px solid #30333b;border-radius:12px;background:#1b1d23}
  .modalBtns{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .small{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
<div class="wrap">
  <!-- START (Kid) -->
  <div class="card" id="screen-start">
    <div class="topbar">
      <div class="pill">üéÆ <b>Chattr XP</b> ‚Ä¢ Neon ‚Ä¢ <span class="badge">v12</span></div>
      <div class="row" style="gap:8px">
        <button class="btn ghost" id="btn-parent">Parent</button>
      </div>
    </div>

    <div class="center">
      <div class="emoji" id="brand">‚ú®</div>
      <h1 id="kidGreeting">Ready to play?</h1>
      <p class="meta" id="kidSub">Practice real-world moves. Earn XP. Unlock rewards.</p>

      <!-- NOTE: Kid focus-area buttons removed by design -->
      <div class="spacer"></div>
      <button class="btn" id="btn-start">Play</button>
      <p class="small" style="margin-top:8px" id="questTagline"></p>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="card hide" id="screen-quiz">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="questPill">üß≠ Today‚Äôs Quest</div>
      <div class="meta">üî• Streak: <b id="streak">0</b></div>
    </div>
    <div class="bar"><div id="xpfill"></div></div>
    <div class="meta"><span id="xptext">XP 0</span> ¬∑ Level <span id="level">1</span></div>

    <h3 id="qtext" style="margin-top:10px"></h3>
    <div class="grid" id="answers"></div>
    <div class="meta" id="feedback" style="margin-top:6px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button class="btn ghost" id="btn-exit">Exit</button>
      <button class="btn" id="btn-next" disabled>Next</button>
    </div>
  </div>

  <!-- COOLDOWN (kept for later use) -->
  <div class="card hide" id="screen-cooldown">
    <div class="center">
      <h2>Nice work today üî•</h2>
      <p class="meta">Your brain did reps. Come back tomorrow for more XP.</p>
      <div class="spacer"></div>
      <button class="btn" id="btn-reward">View Reward</button>
      <button class="btn ghost" id="btn-profile">Profile</button>
    </div>
  </div>

  <!-- REWARD (placeholder) -->
  <div class="card hide" id="screen-reward">
    <div class="center">
      <h2>Rewards</h2>
      <div style="font-size:64px">‚úâÔ∏è</div>
      <p class="meta">Tap to reveal a sample code</p>
      <button class="btn" id="btn-open">Open ‚úâÔ∏è</button>
      <div id="codebox" class="hide" style="margin-top:10px">
        <div style="font-size:36px">üß©</div>
        <h3>TEST-1234-ABCD</h3>
        <p class="meta">Use this code in the provider‚Äôs redeem page.</p>
        <button class="btn ghost" id="btn-back-to-quiz">Back</button>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="card hide" id="screen-profile">
    <div class="center">
      <h2>Profile</h2>
      <p class="meta">Theme: Neon ¬∑ Sounds: Off</p>
      <div class="row center" style="justify-content:center;gap:8px">
        <button class="btn" id="btn-play-again">Play Again</button>
        <button class="btn ghost" id="btn-reset">Reset Progress</button>
      </div>
    </div>
  </div>
</div>

<!-- Parent PIN / Dashboard modal -->
<div id="modalRoot" class="modalBack hide">
  <div class="modal" id="modal">
    <h3 id="modalTitle">Parent</h3>
    <div id="modalBody"></div>
    <div class="modalBtns" id="modalBtns"></div>
  </div>
</div>

<div id="confetti" class="confetti"></div>

<script>
  /* =========================
     CONFIG & DATA
     ========================= */
  const DEV_MODE = location.search.includes('dev=1');
  const BYPASS_PARENT = location.search.includes('parent=1'); // helper for testing

  // Areas parents can enable (kids never see these)
  const AREAS = [
    {id:'social',     name:'Social Skills',        icon:'ü´∂'},
    {id:'focus',      name:'Focus & Planning',     icon:'üß≠'},
    {id:'emotion',    name:'Emotion Regulation',   icon:'üåà'},
    {id:'confidence', name:'Confidence & Voice',   icon:'üì£'},
    {id:'digital',    name:'Digital Citizenship',  icon:'üíª'}
  ];

  // Questions tagged by area (sample set)
  const QUESTIONS = [
    // social
    {area:'social', q:"You join a new group chat. Best first message?",
     a:["Hey, I‚Äôm new here! Nice to meet you all.","Spam emojis","Drop a hot take","Ask everyone‚Äôs full names"],
     e:["Friendly + low-pressure. You signal respect and invite normal conversation.",
        "Looks chaotic and attention-seeking; people may mute you immediately.",
        "High-conflict starts make a bad first impression and can split the group.",
        "Feels like an interrogation. Learn names naturally as people talk."],
     c:0},
    {area:'social', q:"A classmate misreads your joke & gets upset. Best fix?",
     a:["Explain and apologize","Double down","Blame autocorrect","Leave the chat"],
     e:["You repair trust quickly. Owning it shows maturity and keeps the friendship.",
        "Escalates hurt feelings and makes you look mean on purpose.",
        "Dodges responsibility; they‚Äôll feel you aren‚Äôt sincere.",
        "Looks like you don‚Äôt care and leaves the problem unsolved."],
     c:0},

    // focus
    {area:'focus', q:"A friend texts during homework time. What‚Äôs your move?",
     a:["Finish this section, then reply","Reply now, it‚Äôs quick","Ignore for hours","Send a meme instead"],
     e:["You keep focus and still respond soon. Less task-switching = faster, calmer finish.",
        "Breaks focus; one quick reply becomes a thread. Work time balloons.",
        "They may feel ignored or worry you‚Äôre upset; silence creates drama.",
        "Off-topic and delays both tasks; sends mixed signals."],
     c:0},

    // emotion
    {area:'emotion', q:"You feel your frustration rising in a conversation. Best next step?",
     a:["Pause and take a breath","Speak faster to get it out","Type in all caps","Quit the chat immediately"],
     e:["A short pause resets tone so you can respond, not react.",
        "Speed increases mistakes and can sound aggressive.",
        "Looks like shouting; others get defensive.",
        "Looks avoidant and leaves things unresolved."],
     c:0},

    // confidence
    {area:'confidence', q:"Someone cuts you off while speaking. What‚Äôs best?",
     a:["Wait, then calmly finish","Interrupt back","Stay silent","Walk out"],
     e:["You set a respectful boundary and model good turn-taking.",
        "Turns it into a battle; everyone stops listening.",
        "Your point gets lost and you teach people it‚Äôs okay to talk over you.",
        "Escalates the situation and can look disrespectful."],
     c:0},

    // digital
    {area:'digital', q:"You see a link offering free game credits. What now?",
     a:["Don‚Äôt click; verify with the official site","Click fast before it expires","Give your login to claim","Share with the group first"],
     e:["Scams often mimic real pages; check official channels first.",
        "Urgency is a scam tactic; hurrying increases risk.",
        "Never share credentials; accounts get stolen.",
        "Spreading unknown links risks your friends, too."],
     c:0}
  ];

  /* =========================
     STORAGE
     ========================= */
  const $ = s => document.querySelector(s), $$ = s => [...document.querySelectorAll(s)];
  const scr = id => { ['#screen-start','#screen-quiz','#screen-cooldown','#screen-reward','#screen-profile'].forEach(sel => $(sel).classList.add('hide')); $(id).classList.remove('hide'); };
  function saveProgress(){ localStorage.setItem('cxp', JSON.stringify(S)); }
  function saveParent(){ localStorage.setItem('cxp_parent', JSON.stringify(P)); }

  // Kid progress (local)
  let S = JSON.parse(localStorage.getItem('cxp')||'{}');
  if (!S.init) { S = { init:true, xp:0, level:1, streak:0, completed:{}}; saveProgress(); }

  // Parent settings (local)
  let P = JSON.parse(localStorage.getItem('cxp_parent')||'{}');
  if (!P.init) { P = { init:true, pinHash:null, preferredName:'', allowedAreas:AREAS.map(a=>a.id) }; saveParent(); }

  /* =========================
     RUNTIME STATE
     ========================= */
  const POINTS_PER_CORRECT = 10;
  const RETRY_GAP = 2; // missed question reappears after N other serves
  let retryQueue = []; // {idx, when}
  let servedCount = 0;
  let idx = -1;
  let awaitingManualAdvance = false;
  let answeredThisQuestion = false;

  /* =========================
     HELPERS
     ========================= */
  const hashPin = pin => pin.split('').reduce((a,ch)=> (a*31 + ch.charCodeAt(0))>>>0, 7) ^ 0xa5a5a5a5;
  const areaName = id => AREAS.find(a=>a.id===id)?.name || id;
  function renderBars(){ $('#streak').textContent=S.streak||0; $('#xptext').textContent=`XP ${S.xp||0}`; $('#level').textContent=S.level||1; $('#xpfill').style.width=((S.xp%100))+'%'; }
  function award(){ S.xp=(S.xp||0)+POINTS_PER_CORRECT; S.level = 1 + Math.floor((S.xp||0)/100); }
  function confetti(){
    const c=$('#confetti');
    for(let i=0;i<22;i++){
      const s=document.createElement('span'); s.className='piece';
      s.textContent=['‚ú®','üí´','üåü','üéâ','‚≠ê'][Math.floor(Math.random()*5)];
      s.style.left=(Math.random()*100)+'%'; s.style.animationDelay=(Math.random()*0.25)+'s';
      c.appendChild(s); setTimeout(()=>s.remove(),1400);
    }
  }
  function allowedQuestionIndices(){
    const set = (P.allowedAreas && P.allowedAreas.length) ? new Set(P.allowedAreas) : new Set(AREAS.map(a=>a.id));
    return QUESTIONS.map((q,i)=> set.has(q.area) ? i : -1).filter(i=>i!==-1);
  }
  function pickNextIndex(){
    // 1) any retry ready?
    const ready = retryQueue.findIndex(it => it.when <= servedCount && !S.completed[it.idx]);
    if (ready !== -1) return retryQueue.splice(ready,1)[0].idx;

    // 2) first unseen from allowed areas
    const allowed = allowedQuestionIndices();
    const i = allowed.find(ii => !S.completed[ii] && ii!==idx);
    if (i !== undefined && i !== -1) return i;

    // 3) pending retries at all?
    if (retryQueue.length) return retryQueue[0].idx;

    // 4) done
    return -1;
  }

  /* =========================
     KID UI
     ========================= */
  function updateKidGreeting(){
    const name = P.preferredName?.trim();
    $('#kidGreeting').textContent = name ? `Hey ${name}, ready to play?` : 'Ready to play?';
    const enabled = (P.allowedAreas && P.allowedAreas.length) ? P.allowedAreas : AREAS.map(a=>a.id);
    const fancy = enabled.map(id => AREAS.find(a=>a.id===id)?.icon + ' ' + areaName(id)).slice(0,3);
    $('#questTagline').textContent = `Today‚Äôs quest pulls from: ${fancy.join(' ¬∑ ')}`;
  }
  updateKidGreeting();

  $('#btn-start').onclick = () => { startSession(); };
  $('#btn-exit').onclick  = () => scr('#screen-start');
  $('#btn-next').onclick  = () => next(true);
  $('#btn-reward').onclick= () => scr('#screen-reward');
  $('#btn-profile').onclick=() => scr('#screen-profile');
  $('#btn-open').onclick  = () => $('#codebox').classList.remove('hide');
  $('#btn-back-to-quiz').onclick = () => scr('#screen-quiz');
  $('#btn-play-again').onclick   = () => startSession();
  $('#btn-reset').onclick = () => { S = { init:true, xp:0, level:1, streak:0, completed:{} }; saveProgress(); renderBars(); alert('Progress reset.'); };

  function startSession(){
    // In dev mode, start each session fresh at 0 points
    if (DEV_MODE) { S = { init:true, xp:0, level:1, streak:0, completed:{} }; saveProgress(); }
    scr('#screen-quiz');
    renderBars();
    servedCount = 0; retryQueue = []; idx = -1;
    // show today‚Äôs quest (random allowed area name)
    const allowed = allowedQuestionIndices();
    const pick = allowed.length ? QUESTIONS[allowed[Math.floor(Math.random()*allowed.length)]].area : AREAS[0].id;
    $('#questPill').textContent = `${AREAS.find(a=>a.id===pick)?.icon || 'üß≠'} Today‚Äôs Quest`;
    next(true);
  }

  function next(manual=false){
    if (awaitingManualAdvance && !manual) return; // ignore any stray calls
    $('#btn-next').disabled = true;
    answeredThisQuestion = false;
    awaitingManualAdvance = false;

    const i = pickNextIndex();
    if (i === -1) { scr('#screen-cooldown'); return; }

    idx = i; servedCount++;
    const q = QUESTIONS[idx];
    $('#qtext').textContent = q.q + `  ‚Äî  (${areaName(q.area)})`;
    const box = $('#answers'); box.innerHTML = '';
    q.a.forEach((t,i)=>{
      const d = document.createElement('div');
      d.className = 'answer';
      d.textContent = t;
      d.onclick = () => choose(i, d);
      box.appendChild(d);
    });
    $('#feedback').textContent = '';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function choose(choiceIndex, el){
    if (answeredThisQuestion) return;
    answeredThisQuestion = true;

    const q = QUESTIONS[idx];
    $$('.answer').forEach(a=>a.onclick=null);
    const correct = (choiceIndex === q.c);
    const reason = q.e?.[choiceIndex] || (correct ? "Good call." : "Not ideal‚Äîtry a different approach next time.");

    if (correct){
      el.classList.add('correct');
      S.completed[idx] = true;
      S.streak = (S.streak||0) + 1;
      award();
      $('#feedback').textContent = `‚úÖ ${reason}`;
      confetti();
    } else {
      el.classList.add('wrong');
      S.streak = 0;
      retryQueue.push({ idx, when: servedCount + RETRY_GAP });
      const better = q.a[q.c];
      $('#feedback').innerHTML = `‚ùå ${reason} <br><span class="meta">Try next time: ‚Äú${better}‚Äù.</span>`;
    }
    saveProgress(); renderBars();
    awaitingManualAdvance = true;
    $('#btn-next').disabled = false;
  }

  /* =========================
     PARENT: PIN & DASHBOARD
     ========================= */
  const modalRoot = $('#modalRoot'), modalTitle = $('#modalTitle'), modalBody = $('#modalBody'), modalBtns = $('#modalBtns');

  function openModal(title, bodyHTML, buttons){
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHTML;
    modalBtns.innerHTML = '';
    buttons.forEach(b=>{
      const btn = document.createElement('button');
      btn.className = 'btn' + (b.ghost ? ' ghost' : '');
      btn.textContent = b.text;
      btn.onclick = b.onClick;
      modalBtns.appendChild(btn);
    });
    modalRoot.classList.remove('hide');
  }
  function closeModal(){ modalRoot.classList.add('hide'); }

  function showCreatePin(){
    openModal('Create Parent PIN', `
      <div class="formrow"><label>PIN</label><input type="password" maxlength="4" class="pin" id="pin1" inputmode="numeric" placeholder="4 digits"></div>
      <div class="formrow"><label>Confirm</label><input type="password" maxlength="4" class="pin" id="pin2" inputmode="numeric" placeholder="4 digits"></div>
      <p class="small">This PIN is stored only on this device.</p>
    `, [
      {text:'Cancel', ghost:true, onClick:()=>closeModal()},
      {text:'OK', onClick:()=>{
        const a = $('#pin1').value.trim(), b=$('#pin2').value.trim();
        if (!/^\d{4}$/.test(a)) return alert('Please enter a 4-digit PIN.');
        if (a!==b) return alert('PINs do not match.');
        P.pinHash = hashPin(a); saveParent(); closeModal(); showParentDash();
      }}
    ]);
  }

  function showEnterPin(){
    openModal('Parent PIN', `
      <div class="formrow"><label>Enter PIN</label><input type="password" maxlength="4" class="pin" id="pinIn" inputmode="numeric" placeholder="4 digits"></div>
      <p class="small">Forgot it? Clear site data for github.io to reset.</p>
    `, [
      {text:'Cancel', ghost:true, onClick:()=>closeModal()},
      {text:'Unlock', onClick:()=>{
        const a = $('#pinIn').value.trim();
        if (!/^\d{4}$/.test(a)) return alert('Please enter your 4-digit PIN.');
        if (hashPin(a) !== P.pinHash) return alert('Incorrect PIN.');
        closeModal(); showParentDash();
      }}
    ]);
  }

  function showParentDash(){
    const checkboxes = AREAS.map(a=>{
      const checked = (P.allowedAreas||[]).includes(a.id) ? 'checked' : '';
      return `<label class="check"><input type="checkbox" data-area="${a.id}" ${checked}/> <span>${a.icon} ${a.name}</span></label>`;
    }).join('');

    openModal('Parent Dashboard', `
      <div class="formrow">
        <label>Preferred name</label>
        <input id="prefName" class="input" placeholder="What should the app call your child?" value="${(P.preferredName||'').replace(/"/g,'&quot;')}">
      </div>

      <div class="formrow" style="align-items:start">
        <label>Focus areas</label>
        <div class="checkgrid">${checkboxes}</div>
      </div>

      <div class="formrow">
        <label>Quick actions</label>
        <div class="row">
          <button class="btn ghost" id="qaReset">Reset Progress</button>
          <button class="btn ghost" id="qaAll">Select All</button>
          <button class="btn ghost" id="qaNone">Clear All</button>
        </div>
      </div>
      <p class="small">Changes apply immediately and only affect this device.</p>
    `, [
      {text:'Close', ghost:true, onClick:()=>{ applyParentEdits(); closeModal(); }},
      {text:'Save', onClick:()=>{ applyParentEdits(true); closeModal(); }}
    ]);

    $('#qaReset').onclick = ()=>{ S = { init:true, xp:0, level:1, streak:0, completed:{} }; saveProgress(); alert('Progress reset.'); };
    $('#qaAll').onclick   = ()=>{$$('input[data-area]').forEach(cb=>cb.checked=true);};
    $('#qaNone').onclick  = ()=>{$$('input[data-area]').forEach(cb=>cb.checked=false);};
  }

  function applyParentEdits(showAlert){
    P.preferredName = $('#prefName').value.trim();
    P.allowedAreas = $$('input[data-area]').filter(cb=>cb.checked).map(cb=>cb.getAttribute('data-area'));
    saveParent();
    updateKidGreeting();
    if (showAlert) alert('Saved.');
  }

  $('#btn-parent').onclick = ()=>{
    if (BYPASS_PARENT) return showParentDash();
    if (!P.pinHash) return showCreatePin();
    showEnterPin();
  };

  // Dismiss modal by clicking backdrop (optional)
  modalRoot.addEventListener('click', (e)=>{ if (e.target===modalRoot) closeModal(); });
</script>
</body>
</html>
