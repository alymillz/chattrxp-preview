<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chattr XP â€¢ Neon Preview</title>
<style>
  :root { --bg:#111216; --surface:#1E1F24; --text:#F8FAFC; --primary:#0EA5E9; --secondary:#EC4899; --success:#10B981; --danger:#ef4444; --muted:#94a3b8; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center}
  .card{width:min(720px,92vw);background:var(--surface);border-radius:20px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1,h2,h3{margin:8px 0}.center{text-align:center}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .16s}
  .btn:hover{transform:translateY(-1px)} .ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .answer{padding:14px;background:#20232a;border-radius:14px;cursor:pointer;user-select:none;transition:transform .12s,background .12s}
  .answer:hover{transform:scale(1.02);background:#262a33}.correct{background:var(--success)!important}.wrong{background:var(--danger)!important}
  .bar{height:12px;width:100%;background:#2a2e36;border-radius:8px;overflow:hidden;margin:8px 0 4px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .28s}
  .meta{color:var(--muted);font-size:14px}.emoji{font-size:38px}.avatars span{font-size:32px;padding:6px 10px;border-radius:10px;cursor:pointer}
  .avatars span.sel{outline:2px solid var(--secondary)} .hide{display:none!important} .spacer{height:8px}
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}.piece{position:absolute;font-size:22px;animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(100vh) rotate(360deg);opacity:0}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="screen-start">
    <div class="center">
      <div class="emoji">âœ¨</div>
      <h1>Chattr XP</h1>
      <p class="meta">Practice real-world social moves. Earn XP. Unlock codes.</p>
      <h3>Pick an avatar</h3>
      <div class="row avatars" id="avatars">
        <span>ğŸ˜âœ¨</span><span>ğŸ§âš¡</span><span>ğŸ€ğŸ’¥</span><span>ğŸ®â­</span><span>ğŸ“šğŸ’¡</span><span>ğŸ§ ğŸ”“</span>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btn-start">Start</button>
    </div>
  </div>

  <div class="card hide" id="screen-quiz">
    <div class="row" style="justify-content:space-between">
      <div><span id="avatar" class="emoji">ğŸ˜âœ¨</span></div>
      <div class="meta">ğŸ”¥ Streak: <b id="streak">1</b></div>
    </div>
    <div class="bar"><div id="xpfill"></div></div>
    <div class="meta"><span id="xptext">XP 0</span> Â· Level <span id="level">1</span></div>

    <h3 id="qtext" style="margin-top:10px"></h3>
    <div class="grid" id="answers"></div>
    <div class="meta" id="feedback"></div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <button class="btn ghost" id="btn-exit">Exit</button>
      <button class="btn" id="btn-next" disabled>Next</button>
    </div>
  </div>

  <div class="card hide" id="screen-cooldown">
    <div class="center">
      <h2>Nice work today ğŸ”¥</h2>
      <p class="meta">Your brain did reps. Come back tomorrow for more XP.</p>
      <div class="spacer"></div>
      <button class="btn" id="btn-reward">View Reward</button>
      <button class="btn ghost" id="btn-profile">Profile</button>
    </div>
  </div>

  <div class="card hide" id="screen-reward">
    <div class="center">
      <h2>Rewards</h2>
      <div style="font-size:64px">âœ‰ï¸</div>
      <p class="meta">Tap to reveal a sample code</p>
      <button class="btn" id="btn-open">Open âœ‰ï¸</button>
      <div id="codebox" class="hide" style="margin-top:10px">
        <div style="font-size:36px">ğŸ§©</div>
        <h3>TEST-1234-ABCD</h3>
        <p class="meta">Use this code in the providerâ€™s redeem page.</p>
        <button class="btn ghost" id="btn-back-to-quiz">Back</button>
      </div>
    </div>
  </div>

  <div class="card hide" id="screen-profile">
    <div class="center">
      <h2>Profile</h2>
      <div class="emoji" id="pAvatar">ğŸ˜âœ¨</div>
      <p class="meta">Theme: Neon Â· Sounds: Off</p>
      <div class="row center" style="justify-content:center;gap:8px">
        <button class="btn" id="btn-play-again">Play Again</button>
        <button class="btn ghost" id="btn-reset">Reset Progress</button>
      </div>
    </div>
  </div>
</div>

<div id="confetti" class="confetti"></div>

<script>
  // --- Dev Mode toggle: add ?dev=1 to URL for unlimited looped testing ---
  const DEV_MODE = location.search.includes('dev=1');

  // Questions with per-answer explanations (e = explanations[])
  const QUESTIONS = [
    {
      q: "A friend texts during homework time. Whatâ€™s your move?",
      a: [
        "Finish this section, then reply",
        "Reply now, itâ€™s quick",
        "Ignore for hours",
        "Send a meme instead"
      ],
      e: [
        "You keep focus and still respond soon. Your brain switches tasks less, so you finish faster and sound calmer.",
        "Looks harmless, but it breaks focus. One quick reply becomes a thread and homework takes longer.",
        "They may feel ignored or worry youâ€™re upset. Silence creates drama you donâ€™t need.",
        "Off-topic and delays both tasks. Sends mixed signals and can seem dismissive."
      ],
      c: 0
    },
    {
      q: "You join a new group chat. Best first message?",
      a: [
        "Hey, Iâ€™m new here! Nice to meet you all.",
        "Spam emojis",
        "Drop a hot take",
        "Ask everyoneâ€™s full names"
      ],
      e: [
        "Friendly + low-pressure. You signal respect and invite normal conversation.",
        "Looks chaotic and attention-seeking; people may mute you immediately.",
        "High-conflict starts make a bad first impression and can split the group.",
        "Feels like an interrogation. Learn names naturally as people talk."
      ],
      c: 0
    },
    {
      q: "A classmate misreads your joke and gets upset. Best fix?",
      a: [
        "Explain and apologize",
        "Double down",
        "Blame autocorrect",
        "Leave the chat"
      ],
      e: [
        "You repair trust quickly. Owning it shows maturity and keeps the friendship.",
        "Escalates hurt feelings and makes you look mean on purpose.",
        "Dodges responsibility; theyâ€™ll feel you arenâ€™t sincere.",
        "Looks like you donâ€™t care and leaves the problem unsolved."
      ],
      c: 0
    },
    {
      q: "Someone cuts you off while speaking. Whatâ€™s best?",
      a: [
        "Wait, then calmly finish",
        "Interrupt back",
        "Stay silent",
        "Walk out"
      ],
      e: [
        "You set a respectful boundary and model good turn-taking.",
        "Turns it into a battle; everyone stops listening and tension rises.",
        "Your point gets lost and you teach people itâ€™s okay to talk over you.",
        "Escalates the situation and can look disrespectful."
      ],
      c: 0
    },
    {
      q: "You forgot a friendâ€™s birthday. What now?",
      a: [
        "Apologize and make it up",
        "Pretend you remembered",
        "Blame your calendar",
        "Ignore it"
      ],
      e: [
        "Honest + effort = trust repair. Small plan > long excuse.",
        "Theyâ€™ll likely find out; trust drops more than if you were honest.",
        "Excuses feel weak and they may think you donâ€™t value them.",
        "Signals they donâ€™t matter to you, which can end friendships."
      ],
      c: 0
    }
  ];

  const $ = s => document.querySelector(s), $$ = s => [...document.querySelectorAll(s)];
  const scr = id => {
    ['#screen-start','#screen-quiz','#screen-cooldown','#screen-reward','#screen-profile']
      .forEach(sel => $(sel).classList.add('hide'));
    $(id).classList.remove('hide');
  };

  // Persisted state
  let S = JSON.parse(localStorage.getItem('cxp')||'{}');
  if (!S.init) { S = { init:true, avatar:'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{} }; save(); }

  // Re-ask missed questions later
  const RETRY_GAP = 2;              // how many questions later to retry a miss
  let retryQueue = [];              // { idx, when }
  let servedCount = 0;
  let idx = -1;

  // Avatar picker
  $$('#avatars span').forEach(sp=>{
    if (sp.textContent === S.avatar) sp.classList.add('sel');
    sp.onclick = () => { $$('#avatars span').forEach(x=>x.classList.remove('sel')); sp.classList.add('sel'); S.avatar = sp.textContent; save(); };
  });

  // Buttons
  $('#btn-start').onclick   = () => { $('#avatar').textContent=S.avatar; $('#pAvatar').textContent=S.avatar; start(); };
  $('#btn-exit').onclick    = () => scr('#screen-start');
  $('#btn-next').onclick    = () => next();
  $('#btn-reward').onclick  = () => scr('#screen-reward');
  $('#btn-profile').onclick = () => scr('#screen-profile');
  $('#btn-open').onclick    = () => $('#codebox').classList.remove('hide');
  $('#btn-back-to-quiz').onclick = () => scr('#screen-quiz');
  $('#btn-play-again').onclick   = () => start();
  $('#btn-reset').onclick = () => {
    S = { init:true, avatar:S.avatar || 'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{} };
    save();
    alert('Progress reset. You can replay from the start.');
  };

  function start(){ scr('#screen-quiz'); renderBars(); servedCount = 0; retryQueue = []; next(true); }

  function pickNextIndex(){
    // 1) Ready retry?
    const ready = retryQueue.findIndex(it => it.when <= servedCount && !S.completed[it.idx]);
    if (ready !== -1) return retryQueue.splice(ready,1)[0].idx;
    // 2) First unseen (skip current to avoid immediate repeat)
    const i = QUESTIONS.findIndex((q,ii)=>!S.completed[ii] && ii!==idx);
    if (i !== -1) return i;
    // 3) Anything pending in retryQueue?
    if (retryQueue.length) return retryQueue[0].idx;
    // 4) Nothing left
    return -1;
  }

  function next(first=false){
    $('#btn-next').disabled = true;
    const i = pickNextIndex();
    if (i === -1) {
      if (DEV_MODE) {
        // Loop forever in Dev Mode
        S.completed = {}; servedCount = 0; retryQueue = [];
        save();
        return next();
      }
      scr('#screen-cooldown'); 
      return;
    }
    idx = i; servedCount++;

    const q = QUESTIONS[idx];
    $('#qtext').textContent = q.q;
    const box = $('#answers'); box.innerHTML = '';
    q.a.forEach((t,i)=>{
      const d = document.createElement('div');
      d.className = 'answer';
      d.textContent = t;
      d.onclick = () => choose(i, d);
      box.appendChild(d);
    });
    $('#feedback').textContent = '';
    if (!first) window.scrollTo({top:0, behavior:'smooth'});
  }

  function choose(choiceIndex, el){
    const q = QUESTIONS[idx];
    $$('.answer').forEach(a=>a.onclick=null);
    const correct = (choiceIndex === q.c);

    // Explanation text (per answer)
    const reason = q.e?.[choiceIndex] || (correct ? "Good call." : "Not idealâ€”let's try a different approach next time.");

    if (correct){
      el.classList.add('correct');
      S.completed[idx] = true;
      S.streak = (S.streak||0) + 1;
      award();
      $('#feedback').textContent = `âœ… ${reason}`;
      confetti();
    } else {
      el.classList.add('wrong');
      S.streak = 0;
      retryQueue.push({ idx, when: servedCount + RETRY_GAP }); // queue for later
      const better = q.a[q.c];
      $('#feedback').innerHTML = `âŒ ${reason} <br><span class="meta">Try next time: â€œ${better}â€.</span>`;
    }

    save(); renderBars();
    setTimeout(()=>{ $('#btn-next').disabled=false; next(); }, 900); // auto-advance
  }

  function award(){ S.xp = (S.xp||0) + 10; S.level = 1 + Math.floor((S.xp||0)/100); }
  function renderBars(){ $('#streak').textContent=S.streak||0; $('#xptext').textContent=`XP ${S.xp||0}`; $('#level').textContent=S.level||1; $('#xpfill').style.width=((S.xp%100))+'%'; }
  function save(){ localStorage.setItem('cxp', JSON.stringify(S)); }

  function confetti(){
    const c=document.getElementById('confetti');
    for(let i=0;i<22;i++){
      const s=document.createElement('span'); s.className='piece';
      s.textContent=['âœ¨','ğŸ’«','ğŸŒŸ','ğŸ‰','â­'][Math.floor(Math.random()*5)];
      s.style.left=(Math.random()*100)+'%'; s.style.animationDelay=(Math.random()*0.25)+'s';
      c.appendChild(s); setTimeout(()=>s.remove(),1400);
    }
  }
</script>
</body>
</html>
