<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chattr XP • Neon (Parent + Profiles)</title>
<style>
  :root {
    --bg:#111216; --surface:#1c1f25; --text:#f8fafc;
    --primary:#0ea5e9; --secondary:#ec4899; --success:#10b981; --danger:#ef4444; --muted:#9aa5b1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{width:min(820px,94vw);background:var(--surface);border-radius:20px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1,h2,h3{margin:8px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .between{justify-content:space-between}
  .center{text-align:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .16s}
  .btn:hover{transform:translateY(-1px)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .linklike{background:transparent;border:0;color:var(--muted);text-decoration:underline;cursor:pointer}
  .avatars span{font-size:32px;padding:6px 10px;border-radius:10px;cursor:pointer}
  .avatars span.sel{outline:2px solid var(--secondary)}
  .emoji{font-size:38px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .answer{padding:14px;background:#222733;border-radius:14px;cursor:pointer;user-select:none;transition:transform .12s,background .12s}
  .answer:hover{transform:scale(1.02);background:#263042}
  .correct{background:var(--success)!important}
  .wrong{background:var(--danger)!important}
  .bar{height:12px;width:100%;background:#2a2e36;border-radius:8px;overflow:hidden;margin:8px 0 4px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .28s}
  .meta{color:var(--muted);font-size:14px}
  .hide{display:none!important}
  .gear{position:absolute;top:14px;right:14px;font-size:22px;cursor:pointer;opacity:.85}
  .gear:hover{opacity:1;transform:rotate(15deg)}
  .topbar{position:relative}
  .badge{font-size:12px;color:#aab3bd}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#273042;color:#cfe8f8;font-size:12px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(720px,92vw);background:#171a20;border:1px solid #2b3240;border-radius:16px;padding:18px}
  .hr{height:1px;background:#2a3240;margin:10px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 12px;border-radius:999px;background:#243041;color:#d9e7f4;cursor:pointer;border:1px solid #314058}
  .chip.sel{outline:2px solid var(--primary)}
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;font-size:22px;animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(100vh) rotate(360deg);opacity:0}}
  .kicker{font-size:13px;color:#b7c3cf;margin-bottom:6px}
  .section{padding:10px;border:1px solid #2c3546;border-radius:12px;margin:8px 0}
  label{display:block;margin:6px 0}
  input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:10px;border:1px solid #364055;background:#0f1217;color:#eaf2ff}
</style>
</head>
<body>

<div class="wrap">
  <div class="card" id="screen-home">
    <div class="topbar">
      <div class="gear" id="btn-gear" title="Parent">⚙️</div>
    </div>
    <div class="center">
      <div class="emoji">✨</div>
      <h1>Chattr XP</h1>
      <p class="meta" id="home-sub">Level up your social game. Have fun while you’re at it.</p>
      <div class="row center" style="justify-content:center;margin-top:10px">
        <div class="avatars" id="avatars">
          <span>😎✨</span><span>🎧⚡</span><span>🏀💥</span><span>🎮⭐</span><span>📚💡</span><span>🧠🔓</span>
        </div>
      </div>
      <div class="row center" style="justify-content:center;margin-top:14px;gap:8px">
        <button class="btn" id="btn-play">Play</button>
        <button class="btn ghost" id="btn-profile">Profile</button>
      </div>
      <p class="badge" id="active-profile-badge"></p>
    </div>
  </div>

  <div class="card hide" id="screen-quiz">
    <div class="row between">
      <div><span id="avatar" class="emoji">😎✨</span> <span class="pill" id="pill-areas"></span></div>
      <div class="meta">🔥 Streak: <b id="streak">0</b></div>
    </div>
    <div class="bar"><div id="xpfill"></div></div>
    <div class="meta"><span id="xptext">XP 0</span> · Level <span id="level">1</span></div>
    <h3 id="qtext" style="margin-top:10px"></h3>
    <div class="grid2" id="answers"></div>
    <div id="feedback" class="meta" style="margin-top:6px"></div>
    <div class="row between" style="margin-top:12px">
      <button class="btn ghost" id="btn-exit">Exit</button>
      <button class="btn" id="btn-next" disabled>Next</button>
    </div>
  </div>

  <div class="card hide" id="screen-profile">
    <div class="center">
      <h2>Profile</h2>
      <div class="emoji" id="pAvatar">😎✨</div>
      <p class="meta">Theme: Neon · Sounds: Off</p>
      <div class="row center" style="justify-content:center;gap:8px;margin-top:8px">
        <button class="btn" id="btn-play-again">Play Again</button>
        <button class="btn ghost" id="btn-reset">Reset Progress</button>
      </div>
    </div>
  </div>
</div>

<!-- Connect to Supabase -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Paste your own values here:
  const SUPABASE_URL  = 'YOUR_PROJECT_URL_HERE';
  const SUPABASE_ANON = 'YOUR_ANON_KEY_HERE';

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
  window.__sb = sb;

  async function fetchBatch(areaIds, limit = 200) {
    const { data, error } = await sb
      .from('questions')
      .select('id, area_id, prompt, choices, explanations, correct_index')
      .in('area_id', areaIds)
      .eq('is_active', true)
      .limit(limit);

    if (error) {
      console.error('Error loading questions:', error);
      return [];
    }

    return data.map(row => ({
      __id: row.id,
      area: row.area_id,
      q: row.prompt,
      a: row.choices,
      e: row.explanations,
      c: row.correct_index
    }));
  }
  window.fetchBatch = fetchBatch;
</script>

<script>
/* ----------------------- Flags & URL helpers ----------------------- */
const DEV_MODE = location.search.includes('dev=1');
const RESET_NOW = location.search.includes('reset=1');
const url = new URL(location.href);
const PARAM_PROFILE = (url.searchParams.get('profile') || '').trim();

/* ----------------------- Data: Areas ----------------------- */
const AREAS = [
  { id:'chill',  name:'Calm & Reset' },
  { id:'reading',name:'Read the Room' },
  { id:'follow', name:'Show Up & Follow Through' },
  { id:'friend', name:'Friendship Moves' },
];
const Q = []; // questions now come from Supabase

/* ----------------------- State & Storage ----------------------- */
const LS_KEY = "cxp_state_v2";
function defaultState(){
  return {
    settings:{ parentPins:[], enabledAreas: AREAS.map(a=>a.id) },
    profiles:{ "Player": baseProfile() },
    activeProfile:"Player"
  };
}
function baseProfile(){ return { avatar:'😎✨', xp:0, level:1, streak:0, completed:{}, answeredToday:0 }; }
let S = loadState();
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(S)); }
function loadState(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||"null")||defaultState();}catch{return defaultState();} }

/* ----------------------- Helper functions ----------------------- */
function $(s){return document.querySelector(s)}
function $all(s){return [...document.querySelectorAll(s)]}

/* ----------------------- Build and play ----------------------- */
async function buildPool(){
  const enabled = new Set(S.settings.enabledAreas);
  const areas = [...enabled];
  const batch = await window.fetchBatch(areas, 300);
  POOL = batch.map((q, idx) => ({ q, idx }));
  shuffleInPlace(POOL);
}

/* ----------------------- Quiz logic ----------------------- */
let POOL = [];
let servedCount = 0;
let retryQueue = [];
let awaitingManualAdvance = false;
let currentQ = null;

const RETRY_GAP = 2;
const POINTS_PER_CORRECT = 10;

$('#btn-exit').onclick=()=>show('#screen-home');
$('#btn-next').onclick=()=>next(true);

$('#btn-play').onclick=()=>startSession();
$('#btn-profile').onclick=()=>{ $('#pAvatar').textContent=activeP().avatar; show('#screen-profile'); };
$('#btn-play-again').onclick=()=>startSession();
$('#btn-reset').onclick=()=>{ const n=getProfileName(); S.profiles[n]={...baseProfile(),avatar:S.profiles[n]?.avatar||'😎✨'}; saveState(); alert('Progress reset.'); };

async function startSession(){
  await buildPool();
  servedCount=0; retryQueue=[]; awaitingManualAdvance=false;
  $('#avatar').textContent=activeP().avatar;
  renderAreaPill(); renderBars();
  show('#screen-quiz');
  next(true);
}

function next(manual=false){
  if (awaitingManualAdvance && !manual) return;
  $('#btn-next').disabled=true;
  $('#feedback').textContent='';
  const i = servedCount;
  if (!POOL[i]) { show('#screen-home'); return; }
  servedCount++;
  loadQuestion(i);
}

function loadQuestion(i){
  const base = POOL[i].q;
  const map=[0,1,2,3]; shuffleInPlace(map);
  const shuffledA = map.map(k=>base.a[k]);
  const shuffledE = map.map(k=>base.e[k]);
  const correctIdx = map.indexOf(base.c);

  currentQ={__idx:i,area:base.area,q:base.q,a:shuffledA,e:shuffledE,correctIdx};
  $('#qtext').textContent=currentQ.q;
  const box=$('#answers'); box.innerHTML='';
  currentQ.a.forEach((t,ix)=>{
    const d=document.createElement('div');
    d.className='answer';
    d.textContent=t;
    d.onclick=()=>choose(ix,d);
    box.appendChild(d);
  });
}

function choose(choiceIdx,el){
  $all('.answer').forEach(a=>a.onclick=null);
  const correct=(choiceIdx===currentQ.correctIdx);
  const p=activeP();
  if(correct){
    el.classList.add('correct');
    markCompleted(currentQ.__idx);
    p.streak=(p.streak||0)+1;
    awardPoints(p);
    $('#feedback').textContent=`✅ Nice. ${currentQ.e[choiceIdx]}`;
    confetti();
  } else {
    el.classList.add('wrong');
    p.streak=0;
    $('#feedback').textContent=`Thanks for thinking it through. ${currentQ.e[choiceIdx]}`;
  }
  saveState(); renderBars(); awaitingManualAdvance=true; $('#btn-next').disabled=false;
}

/* ----------------------- Render helpers ----------------------- */
function renderBars(){
  const p=activeP();
  $('#streak').textContent=p.streak||0;
  $('#xptext').textContent=`XP ${p.xp||0}`;
  $('#level').textContent=p.level||1;
  const pct=Math.min(100,(p.xp%100));
  $('#xpfill').style.width=pct+'%';
}
function awardPoints(p){p.xp=(p.xp||0)+POINTS_PER_CORRECT;p.level=1+Math.floor((p.xp||0)/100);}
function renderAreaPill(){
  const enabled=new Set(S.settings.enabledAreas);
  const names=AREAS.filter(a=>enabled.has(a.id)).map(a=>a.name);
  $('#pill-areas').textContent=names.length===AREAS.length?'All Modes':names.join(' • ');
}

/* ----------------------- Utils ----------------------- */
function shuffleInPlace(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}

/* ----------------------- Profiles (simplified local) ----------------------- */
function getProfileName(){return S.activeProfile||"Player";}
function activeP(){const n=getProfileName();if(!S.profiles[n])S.profiles[n]=baseProfile();return S.profiles[n];}
function markCompleted(idx){const p=activeP();p.completed[idx]=true;}
function confetti(){const c=$('#confetti')||document.body.appendChild(Object.assign(document.createElement('div'),{id:'confetti',className:'confetti'}));for(let i=0;i<20;i++){const s=document.createElement('span');s.className='piece';s.textContent=['✨','💫','🌟','🎉','⭐'][Math.floor(Math.random()*5)];s.style.left=(Math.random()*100)+'%';s.style.animationDelay=(Math.random()*0.25)+'s';c.appendChild(s);setTimeout(()=>s.remove(),1400);}}
function show(id){['#screen-home','#screen-quiz','#screen-profile'].forEach(sel=>$(sel).classList.add('hide'));$(id).classList.remove('hide');}
function boot(){show('#screen-home');}boot();
</script>
</body>
</html>
