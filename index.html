<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chattr XP â€¢ Neon Preview (v11)</title>
<style>
  :root { --bg:#111216; --surface:#1E1F24; --text:#F8FAFC; --primary:#0EA5E9; --secondary:#EC4899; --success:#10B981; --danger:#ef4444; --muted:#94a3b8; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{width:min(860px,94vw);background:var(--surface);border-radius:20px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1,h2,h3{margin:8px 0}.center{text-align:center}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .16s}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn:hover{transform:translateY(-1px)}
  .btn.small{padding:8px 12px;font-size:14px}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:6px}
  .chip{padding:10px 12px;border:1px solid #2a2e36;border-radius:12px;cursor:pointer}
  .chip.sel{border-color:var(--secondary);outline:2px solid rgba(236,72,153,.35)}
  .answer{padding:14px;background:#20232a;border-radius:14px;cursor:pointer;user-select:none;transition:transform .12s,background .12s}
  .answer:hover{transform:scale(1.02);background:#262a33}
  .correct{background:var(--success)!important}
  .wrong{background:var(--danger)!important}
  .bar{height:12px;width:100%;background:#2a2e36;border-radius:8px;overflow:hidden;margin:8px 0 4px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .28s}
  .meta{color:var(--muted);font-size:14px}
  .emoji{font-size:38px}
  .avatars span{font-size:32px;padding:6px 10px;border-radius:10px;cursor:pointer}
  .avatars span.sel{outline:2px solid var(--secondary)}
  .hide{display:none!important}
  .spacer{height:8px}
  .badge{font-size:12px;color:#aaa}
  input[type="text"], input[type="password"], select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2e36;background:#17181c;color:var(--text)}
  label{font-size:14px;color:#cbd5e1}
  .small{font-size:12px;color:#94a3b8}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);padding:20px}
  .modal.show{display:flex}
  .modal .sheet{width:min(420px,92vw);background:#1c1d22;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
</style>
</head>
<body>

<div class="wrap">

  <!-- PARENT DASHBOARD -->
  <div class="card hide" id="screen-parent">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h2 style="margin:0">Parent Dashboard</h2>
        <p class="meta" style="margin:2px 0 0">Set your childâ€™s preferred name and choose focus areas.</p>
      </div>
      <div class="row" style="gap:8px">
        <span class="badge">v11</span>
        <button class="btn ghost small" id="btn-parent-exit">Done</button>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label for="childNameInput">Preferred Name</label>
        <input id="childNameInput" type="text" placeholder="e.g., Jordan" />
        <p class="small">Weâ€™ll greet your child using this on the Start screen and in-game.</p>
      </div>
      <div>
        <label for="areaMode">When playing, default to</label>
        <select id="areaMode">
          <option value="focus">Only the selected focus areas</option>
          <option value="all">All areas</option>
        </select>
        <p class="small">Kids can still switch on the Start screen.</p>
      </div>
    </div>

    <h3 style="margin-top:4px">Focus Areas</h3>
    <div class="grid3" id="parentAreas"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btn-select-all">Select All</button>
      <button class="btn ghost" id="btn-clear-all">Clear</button>
      <button class="btn" id="btn-parent-save">Save Changes</button>
    </div>

    <div style="margin-top:16px">
      <h3>What these areas mean</h3>
      <ul class="small" style="margin-top:6px">
        <li><b>Calm Skills</b> â€” pause, breathe, plan your next move.</li>
        <li><b>Talk Builder</b> â€” openers, tone, empathy in 1-to-1 chats.</li>
        <li><b>Group Chat IQ</b> â€” timing, memes, not flooding, reading the room.</li>
        <li><b>Boundaries & Consent</b> â€” saying no, respecting no, check-ins.</li>
        <li><b>Focus & Habits</b> â€” screens vs homework, routines, rewards.</li>
        <li><b>Empathy Mode</b> â€” perspective taking, repair after harm.</li>
        <li><b>School Collab</b> â€” teachers, group projects, study buddies.</li>
        <li><b>Digital Drama</b> â€” rumors, screenshots, cooler heads.</li>
        <li><b>Conflict Reset</b> â€” de-escalation, â€œrepairâ€ messages, bridges.</li>
      </ul>
    </div>
  </div>

  <!-- START -->
  <div class="card" id="screen-start">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="emoji">âœ¨</div>
      <div class="row" style="gap:8px">
        <button class="btn ghost small" id="btn-parent-open">Parent</button>
      </div>
    </div>

    <div class="center" style="margin-top:8px">
      <h1 style="margin-bottom:4px">Chattr XP</h1>
      <p class="meta">Practice real-world social moves. Earn XP. Unlock codes.</p>
      <p class="badge">Preview v11</p>

      <h3 id="helloName" class="hide"></h3>

      <h3 style="margin-top:10px">Pick an avatar</h3>
      <div class="row avatars" id="avatars">
        <span>ğŸ˜âœ¨</span><span>ğŸ§âš¡</span><span>ğŸ€ğŸ’¥</span><span>ğŸ®â­</span><span>ğŸ“šğŸ’¡</span><span>ğŸ§ ğŸ”“</span>
      </div>

      <h3 style="margin-top:14px">What do you want to practice?</h3>
      <div class="grid3" id="kidAreas"></div>

      <div class="spacer"></div>
      <button class="btn" id="btn-start">Start</button>

      <div class="spacer"></div>
      <p class="small">Tip for parents: tap â€œParentâ€ above. First time youâ€™ll set a 4-digit PIN.</p>
      <p class="small">Dev shortcuts: add <code>?dev=1</code> for testing; <code>?parent=1</code> opens dashboard.</p>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="card hide" id="screen-quiz">
    <div class="row" style="justify-content:space-between">
      <div><span id="avatar" class="emoji">ğŸ˜âœ¨</span></div>
      <div class="meta"><span id="helloInline" class="hide"></span> ğŸ”¥ Streak: <b id="streak">0</b></div>
    </div>
    <div class="bar"><div id="xpfill"></div></div>
    <div class="meta"><span id="xptext">XP 0</span> Â· Level <span id="level">1</span></div>

    <h3 id="qtext" style="margin-top:10px"></h3>
    <div class="grid2" id="answers"></div>
    <div class="meta" id="feedback" style="margin-top:6px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button class="btn ghost" id="btn-exit">Exit</button>
      <button class="btn" id="btn-next" disabled>Next</button>
    </div>
  </div>

  <!-- COOLDOWN -->
  <div class="card hide" id="screen-cooldown">
    <div class="center">
      <h2>Nice work today ğŸ”¥</h2>
      <p class="meta">Your brain did reps. Come back tomorrow for more XP.</p>
      <div class="spacer"></div>
      <button class="btn" id="btn-reward">View Reward</button>
      <button class="btn ghost" id="btn-profile">Profile</button>
    </div>
  </div>

  <!-- REWARD -->
  <div class="card hide" id="screen-reward">
    <div class="center">
      <h2>Rewards</h2>
      <div style="font-size:64px">âœ‰ï¸</div>
      <p class="meta">Tap to reveal a sample code</p>
      <button class="btn" id="btn-open">Open âœ‰ï¸</button>
      <div id="codebox" class="hide" style="margin-top:10px">
        <div style="font-size:36px">ğŸ§©</div>
        <h3>TEST-1234-ABCD</h3>
        <p class="meta">Use this code in the providerâ€™s redeem page.</p>
        <button class="btn ghost" id="btn-back-to-quiz">Back</button>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="card hide" id="screen-profile">
    <div class="center">
      <h2>Profile</h2>
      <div class="emoji" id="pAvatar">ğŸ˜âœ¨</div>
      <p class="meta">Theme: Neon Â· Sounds: Off</p>
      <div class="row center" style="justify-content:center;gap:8px">
        <button class="btn" id="btn-play-again">Play Again</button>
        <button class="btn ghost" id="btn-reset">Reset Progress</button>
      </div>
    </div>
  </div>

</div>

<div id="confetti" class="confetti"></div>

<!-- Parent PIN Modal -->
<div class="modal" id="pinModal">
  <div class="sheet">
    <h3 id="pinTitle">Parent Access</h3>
    <p class="meta" id="pinHint">Enter your 4-digit PIN to open the dashboard.</p>
    <div class="grid2" style="margin-top:8px">
      <input id="pin1" type="password" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
      <input id="pin2" class="hide" type="password" inputmode="numeric" maxlength="4" placeholder="Confirm â€¢â€¢â€¢â€¢" />
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="pinOk">OK</button>
      <button class="btn ghost" id="pinCancel">Cancel</button>
    </div>
    <p class="small" style="margin-top:8px">Forgot PIN? Clear this siteâ€™s data in your browser to reset. (Local-only demo security.)</p>
  </div>
</div>

<script>
  // --- Modes via URL ---
  const DEV_MODE = location.search.includes('dev=1');
  const PARENT_MODE = location.search.includes('parent=1');

  // --- Focus Areas ---
  const AREAS = [
    {id:'calm',    name:'Calm Skills',       icon:'ğŸ§˜'},
    {id:'talk',    name:'Talk Builder',      icon:'ğŸ’¬'},
    {id:'group',   name:'Group Chat IQ',     icon:'ğŸ‘¥'},
    {id:'bounds',  name:'Boundaries & Consent',icon:'ğŸ›‘'},
    {id:'focus',   name:'Focus & Habits',    icon:'ğŸ¯'},
    {id:'empathy', name:'Empathy Mode',      icon:'ğŸ¤'},
    {id:'school',  name:'School Collab',     icon:'ğŸ«'},
    {id:'drama',   name:'Digital Drama',     icon:'ğŸ“±'},
    {id:'reset',   name:'Conflict Reset',    icon:'ğŸ•Šï¸'}
  ];

  // --- Demo questions with area tags + explanations ---
  const QUESTIONS = [
    { area:'focus',
      q:"A friend texts during homework time. Whatâ€™s your move?",
      a:["Finish this section, then reply","Reply now, itâ€™s quick","Ignore for hours","Send a meme instead"],
      e:[
        "You keep focus and still respond soon. Your brain switches tasks less, so you finish faster and sound calmer.",
        "Looks harmless, but it breaks focus. One quick reply becomes a thread and homework takes longer.",
        "They may feel ignored or worry youâ€™re upset. Silence creates drama you donâ€™t need.",
        "Off-topic and delays both tasks. Sends mixed signals and can seem dismissive."
      ], c:0
    },
    { area:'group',
      q:"You join a new group chat. Best first message?",
      a:["Hey, Iâ€™m new here! Nice to meet you all.","Spam emojis","Drop a hot take","Ask everyoneâ€™s full names"],
      e:[
        "Friendly + low-pressure. You signal respect and invite normal conversation.",
        "Looks chaotic and attention-seeking; people may mute you immediately.",
        "High-conflict starts make a bad first impression and can split the group.",
        "Feels like an interrogation. Learn names naturally as people talk."
      ], c:0
    },
    { area:'empathy',
      q:"A classmate misreads your joke and gets upset. Best fix?",
      a:["Explain and apologize","Double down","Blame autocorrect","Leave the chat"],
      e:[
        "You repair trust quickly. Owning it shows maturity and keeps the friendship.",
        "Escalates hurt feelings and makes you look mean on purpose.",
        "Dodges responsibility; theyâ€™ll feel you arenâ€™t sincere.",
        "Looks like you donâ€™t care and leaves the problem unsolved."
      ], c:0
    },
    { area:'talk',
      q:"Someone cuts you off while speaking. Whatâ€™s best?",
      a:["Wait, then calmly finish","Interrupt back","Stay silent","Walk out"],
      e:[
        "You set a respectful boundary and model good turn-taking.",
        "Turns it into a battle; everyone stops listening and tension rises.",
        "Your point gets lost and you teach people itâ€™s okay to talk over you.",
        "Escalates the situation and can look disrespectful."
      ], c:0
    },
    { area:'reset',
      q:"You forgot a friendâ€™s birthday. What now?",
      a:["Apologize and make it up","Pretend you remembered","Blame your calendar","Ignore it"],
      e:[
        "Honest + effort = trust repair. Small plan > long excuse.",
        "Theyâ€™ll likely find out; trust drops more than if you were honest.",
        "Excuses feel weak and they may think you donâ€™t value them.",
        "Signals they donâ€™t matter to you, which can end friendships."
      ], c:0
    }
  ];

  // --- Helpers ---
  const $ = s => document.querySelector(s), $$ = s => [...document.querySelectorAll(s)];
  const scr = id => { ['#screen-parent','#screen-start','#screen-quiz','#screen-cooldown','#screen-reward','#screen-profile'].forEach(sel => $(sel).classList.add('hide')); $(id).classList.remove('hide'); };

  // --- Storage ---
  let S = JSON.parse(localStorage.getItem('cxp')||'{}');
  if (!S.init) { S = { init:true, avatar:'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{}, areasMode:'focus', chosenAreas:AREAS.map(a=>a.id) }; save(); }
  let P = JSON.parse(localStorage.getItem('cxp_parent')||'{}'); // parent settings + pin
  if (!P.init) { P = { init:true, childName:'', focusAreas:AREAS.map(a=>a.id), areaMode:'focus', pinHash:'' }; saveParent(); }

  function save(){ localStorage.setItem('cxp', JSON.stringify(S)); }
  function saveParent(){ localStorage.setItem('cxp_parent', JSON.stringify(P)); }

  // --- Retry / quiz state ---
  const RETRY_GAP = 2;
  let retryQueue = [];  // { idx, when }
  let servedCount = 0;
  let idx = -1;
  let answeredThisQuestion = false;
  let awaitingManualAdvance = false;

  // --- Parent chips (dashboard) ---
  const parentAreaBox = $('#parentAreas');
  AREAS.forEach(a=>{
    const div = document.createElement('div');
    div.className = 'chip';
    div.dataset.id = a.id;
    div.textContent = `${a.icon} ${a.name}`;
    parentAreaBox.appendChild(div);
  });
  function renderParentChips(){
    $$('#parentAreas .chip').forEach(ch=>{
      const on = P.focusAreas.includes(ch.dataset.id);
      ch.classList.toggle('sel', on);
    });
    $('#childNameInput').value = P.childName || '';
    $('#areaMode').value = P.areaMode || 'focus';
  }
  parentAreaBox.addEventListener('click',(e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const id = chip.dataset.id;
    if (P.focusAreas.includes(id)) P.focusAreas = P.focusAreas.filter(x=>x!==id);
    else P.focusAreas.push(id);
    renderParentChips();
  });
  $('#btn-select-all').onclick = ()=>{ P.focusAreas = AREAS.map(a=>a.id); renderParentChips(); };
  $('#btn-clear-all').onclick = ()=>{ P.focusAreas = []; renderParentChips(); };
  $('#btn-parent-save').onclick = ()=>{
    P.childName = ($('#childNameInput').value || '').trim();
    P.areaMode  = $('#areaMode').value;
    saveParent();
    refreshHello();
    buildKidAreas();
    alert('Saved!');
  };
  $('#btn-parent-exit').onclick = ()=>{ scr('#screen-start'); refreshHello(); buildKidAreas(); };

  // --- Kid area chips (start screen) ---
  const kidAreaBox = $('#kidAreas');
  function buildKidAreas(){
    kidAreaBox.innerHTML = '';
    const enabled = P.focusAreas.length ? P.focusAreas : AREAS.map(a=>a.id);
    const allDiv = document.createElement('div');
    allDiv.className = 'chip'; allDiv.dataset.id='__all'; allDiv.textContent='ğŸŒˆ All My Focus Areas';
    kidAreaBox.appendChild(allDiv);
    AREAS.forEach(a=>{
      if (!enabled.includes(a.id)) return;
      const div = document.createElement('div');
      div.className='chip'; div.dataset.id=a.id; div.textContent=`${a.icon} ${a.name}`;
      kidAreaBox.appendChild(div);
    });
    const defaultIsAll = (P.areaMode || 'focus') === 'all';
    selectKidAreas(defaultIsAll ? ['__all'] : enabled.slice());
  }
  function selectKidAreas(ids){
    $$('#kidAreas .chip').forEach(ch=>ch.classList.toggle('sel', ids.includes(ch.dataset.id)));
    if (ids.includes('__all')) S.chosenAreas = P.focusAreas.slice();
    else S.chosenAreas = ids.slice();
    save();
  }
  kidAreaBox.addEventListener('click',(e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    if (chip.dataset.id==='__all'){ selectKidAreas(['__all']); return; }
    const current = $$('#kidAreas .chip.sel').map(x=>x.dataset.id);
    const id = chip.dataset.id;
    let next = current.includes(id) ? current.filter(x=>x!==id) : current.concat(id);
    next = next.filter(x=>x!=='__all');
    if (next.length===0) next=['__all'];
    selectKidAreas(next);
  });

  // --- Avatar picker ---
  $$('#avatars span').forEach(sp=>{
    if (sp.textContent === S.avatar) sp.classList.add('sel');
    sp.onclick = () => { $$('#avatars span').forEach(x=>x.classList.remove('sel')); sp.classList.add('sel'); S.avatar = sp.textContent; save(); };
  });

  // --- Greeting + Start button label with preferred name ---
  function refreshHello(){
    const name = (P.childName || '').trim();
    const hello = $('#helloName');
    const inline = $('#helloInline');
    const startBtn = $('#btn-start');
    if (name){
      hello.textContent = `Hi, ${name} ğŸ‘‹`;
      hello.classList.remove('hide');
      inline.textContent = `${name} â€¢`;
      inline.classList.remove('hide');
      startBtn.textContent = `Start, ${name}`;
    } else {
      hello.classList.add('hide');
      inline.classList.add('hide');
      startBtn.textContent = 'Start';
    }
  }

  // --- Parent PIN modal logic ---
  const pinModal = $('#pinModal'), pin1 = $('#pin1'), pin2 = $('#pin2'), pinOk = $('#pinOk'), pinCancel = $('#pinCancel'), pinTitle = $('#pinTitle'), pinHint = $('#pinHint');
  function openPinModal(){
    pin1.value = ''; pin2.value = '';
    const hasPin = !!P.pinHash;
    pinTitle.textContent = hasPin ? 'Parent Access' : 'Create Parent PIN';
    pinHint.textContent  = hasPin ? 'Enter your 4-digit PIN to open the dashboard.' : 'Set a 4-digit PIN. Youâ€™ll use this to open the dashboard.';
    pin2.classList.toggle('hide', hasPin); // show confirm only on create
    pinModal.classList.add('show');
    setTimeout(()=>pin1.focus(), 60);
  }
  function closePinModal(){ pinModal.classList.remove('show'); }

  // simple (not secure) hash for demo
  function hash4(s){ let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))|0; return String(h); }

  $('#btn-parent-open').onclick = ()=>{
    // dev backdoor: allow ?parent=1 without PIN
    if (PARENT_MODE) { renderParentChips(); scr('#screen-parent'); return; }
    openPinModal();
  };
  pinCancel.onclick = closePinModal;
  pinOk.onclick = ()=>{
    const v1 = (pin1.value||'').trim();
    if (!/^\d{4}$/.test(v1)) { alert('Please enter a 4-digit PIN.'); return; }
    if (!P.pinHash){
      const v2 = (pin2.value||'').trim();
      if (v1!==v2){ alert('PINs do not match.'); return; }
      P.pinHash = hash4(v1); saveParent();
      closePinModal(); renderParentChips(); scr('#screen-parent');
    } else {
      if (hash4(v1)===P.pinHash){ closePinModal(); renderParentChips(); scr('#screen-parent'); }
      else { alert('Incorrect PIN.'); }
    }
  };

  // --- Buttons (Kid flow) ---
  $('#btn-start').onclick   = () => { $('#avatar').textContent=S.avatar; $('#pAvatar').textContent=S.avatar; startSession(); };
  $('#btn-exit').onclick    = () => scr('#screen-start');
  $('#btn-next').onclick    = () => next(true);     // manual advance
  $('#btn-reward').onclick  = () => scr('#screen-reward');
  $('#btn-profile').onclick = () => scr('#screen-profile');
  $('#btn-open').onclick    = () => $('#codebox').classList.remove('hide');
  $('#btn-back-to-quiz').onclick = () => scr('#screen-quiz');
  $('#btn-play-again').onclick   = () => startSession();
  $('#btn-reset').onclick = () => { resetProgress(true); alert('Progress reset. You can replay from the start.'); };

  // --- Session start / reset ---
  function startSession(){
    if (DEV_MODE) { S = { init:true, avatar:S.avatar || 'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{}, areasMode:S.areasMode||'focus', chosenAreas:S.chosenAreas||P.focusAreas.slice() }; save(); }
    scr('#screen-quiz');
    renderBars();
    servedCount = 0; retryQueue = []; idx = -1; answeredThisQuestion=false; awaitingManualAdvance=false;
    next(true);
  }
  function resetProgress(keepAvatar){
    S = { init:true, avatar: keepAvatar ? (S.avatar || 'ğŸ˜âœ¨') : 'ğŸ˜âœ¨', xp:0, level:1, streak:0, completed:{}, areasMode:S.areasMode||'focus', chosenAreas:S.chosenAreas||P.focusAreas.slice() };
    save(); renderBars();
  }

  // --- Allowed areas ---
  function allowedAreas(){
    const picked = (S.chosenAreas && S.chosenAreas.length) ? S.chosenAreas : P.focusAreas.slice();
    return new Set(picked);
  }
  function nextIndex(){
    const allow = allowedAreas();
    const ready = retryQueue.findIndex(it => it.when <= servedCount && !S.completed[it.idx] && allow.has(QUESTIONS[it.idx].area));
    if (ready !== -1) return retryQueue.splice(ready,1)[0].idx;
    const i = QUESTIONS.findIndex((q,ii)=>!S.completed[ii] && ii!==idx && allow.has(q.area));
    if (i !== -1) return i;
    if (retryQueue.length){
      const any = retryQueue.find(it => allow.has(QUESTIONS[it.idx].area) && !S.completed[it.idx]);
      if (any) return any.idx;
    }
    return -1;
  }

  // --- Quiz flow ---
  function next(manual=false){
    if (awaitingManualAdvance && !manual) return; // ignore stray calls
    $('#btn-next').disabled = true;
    answeredThisQuestion = false;
    awaitingManualAdvance = false;

    const i = nextIndex();
    if (i === -1) {
      if (DEV_MODE) { startSession(); return; } // loop in dev
      scr('#screen-cooldown'); return;
    }

    idx = i; servedCount++;
    const q = QUESTIONS[idx];
    $('#qtext').textContent = `${areaLabel(q.area)}  â€¢  ${q.q}`;
    const box = $('#answers'); box.innerHTML = '';
    q.a.forEach((t,i)=>{
      const d = document.createElement('div');
      d.className = 'answer';
      d.textContent = t;
      d.onclick = () => choose(i, d);
      box.appendChild(d);
    });
    $('#feedback').textContent = '';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function choose(choiceIndex, el){
    if (answeredThisQuestion) return;
    answeredThisQuestion = true;

    const q = QUESTIONS[idx];
    $$('.answer').forEach(a=>a.onclick=null);
    const correct = (choiceIndex === q.c);
    const reason = q.e?.[choiceIndex] || (correct ? "Good call." : "Not idealâ€”let's try a different approach next time.");

    if (correct){
      el.classList.add('correct');
      S.completed[idx] = true;
      S.streak = (S.streak||0) + 1;
      award();
      $('#feedback').textContent = `âœ… ${reason}`;
      confetti();
    } else {
      el.classList.add('wrong');
      S.streak = 0;
      retryQueue.push({ idx, when: servedCount + RETRY_GAP });
      const better = q.a[q.c];
      $('#feedback').innerHTML = `âŒ ${reason} <br><span class="meta">Try next time: â€œ${better}â€.</span>`;
    }

    save(); renderBars();
    awaitingManualAdvance = true;
    $('#btn-next').disabled = false;
  }

  function award(){ S.xp = (S.xp||0) + 10; S.level = 1 + Math.floor((S.xp||0)/100); }
  function renderBars(){ $('#streak').textContent=S.streak||0; $('#xptext').textContent=`XP ${S.xp||0}`; $('#level').textContent=S.level||1; $('#xpfill').style.width=((S.xp%100))+'%'; }
  function areaLabel(id){ const a = AREAS.find(x=>x.id===id); return a ? `${a.icon} ${a.name}` : 'Practice'; }

  // --- Confetti ---
  function confetti(){
    const c=document.getElementById('confetti');
    for(let i=0;i<22;i++){
      const s=document.createElement('span'); s.className='piece';
      s.textContent=['âœ¨','ğŸ’«','ğŸŒŸ','ğŸ‰','â­'][Math.floor(Math.random()*5)];
      s.style.left=(Math.random()*100)+'%'; s.style.animationDelay=(Math.random()*0.25)+'s';
      c.appendChild(s); setTimeout(()=>s.remove(),1400);
    }
  }

  // --- Init ---
  function init(){
    refreshHello();
    buildKidAreas();
    if (PARENT_MODE){ renderParentChips(); scr('#screen-parent'); }
  }
  init();
</script>
</body>
</html>
